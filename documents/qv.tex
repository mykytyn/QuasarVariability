% This file is part of the QuasarVariability project
% Copyright 2013 David W. Hogg (NYU) and any other authors.

\documentclass[letterpaper,12pt,preprint]{aastex}

\newcommand{\project}[1]{\textsl{#1}}
\newcommand{\sdss}{\project{SDSS}}
\newcommand{\lsst}{\project{LSST}}
\newcommand{\ptf}{\project{PTF}}
\newcommand{\panstarrs}{\project{PanSTARRS}}
\newcommand{\given}{\,|\,}
\newcommand{\transpose}[1]{{#1}^{\mathsf{T}}}
\newcommand{\inverse}[1]{{#1}^{-1}}

\begin{document}

\title{Probabilistic models for heterogenous multi-band multi-epoch
  photometry of time-variable quasars.}
\author{DM, EP, DWH, HWR, NH, DFM, others}

\begin{abstract}
Recent projects have built likelihood functions for stochastically
variable quasar light-curves based on Gaussian Processes.  There are
successful models based on damped random walks and also power-law
structure functions, but all of the models effectively assume that the
data are coming from a single photometric bandpass.  Here we generalize
these models so that they can accept data from multiple different
photometric bandpasses, whether or not the data taken through the
different bandpasses are taken simultaneously (as in \sdss) or with
large time lags (as with \panstarrs\ and \lsst).  The model naturally
captures luminosity-correlated color changes.  We test the models on
data from \sdss\ \project{Stripe 82}, in which multi-epoch data was
taken effectively simultaneously in five photometric bandpasses, and
we also test the models on data subsamples in which there are no
simultaneous measurements.  We find that we can infer
structure-function parameters in either case, and that the model can
be used to separate stars and quasars.  We also show that we can infer
time-dependent (and mean) quasar colors, even when a source shows
substantial variability but has not ever been measured simultaneously
in different bands.
\end{abstract}

\keywords{
  this ---
  that ---
  quasars
}

\section{Introduction}

Why what has been done with \sdss\ and \ptf\ data won't be sufficient
for \panstarrs\ and \lsst.
Macleod, et. al. 2010 - ``Modeling the Time Variability of SDSS Stripe 82 Quasars as a Damped Random Walk'':
This paper shows the high degree of agreement between the Damped Random Walk model and quasars from stripe 82. They use a standard covariance matrix of V = a^2 exp (-|delta t / tau|). They are also more interested in overall properties of quasars, not identifying individual objects. As far as I can tell, they do multi-band fitting, but only in the sense that stripe 82 is simultaneous. 

Zu, et. al. 2012 - ``Is Quasar Optical Variability a Damped Random Walk'':
This paper looks at the time sensitive effects of the fitting and also considers some modifications. They also use a standard covariance model, but change it at small time scales in a piecewise manner. The data they used was from OGLE, and was only in one band


Brewer, 2013. (personal communication):
Brewer uses the Gaussian Process to measure time delays in gravitationally lensed quasars. The data used for this Gaussian Process is from all images, not just one image at a time. The structure of the covariance matrix varies with parameters. Generally, the elements of the covariance matrix are given by a function of the form:
\begin{eqnarray}
C_{ij}=\sigma^2 exp\left[-\frac{|t_i-t_j|}{L}\right],
\end{eqnarray}
where $\sigma$ and $L$ are functions of time for quasar variability or a microlensing signal specific to the image. For microslensing signals, the exponential term is raised to a power $\alpha$, which is a smoothness parameter for microlensing signals. Though it is not explicityly stated, I assume that the images are taken in certain bandpasses, from which all magnitudes are combined and used as one vector of measured magnitudes. 

Schmidt et al. 2010 - ``Selecting Quasars by their Intrinsic Variability'':
This method for selecting quasars is carried out by parametrizing single-band variability using a power-law model for the light-curve structure function with an amplitude, $A$ and a power law index, $\gamma$. The power-law model for the structure function is:
\begin{eqnarray}
V_{mod}(\Delta t_{i,j}|A,\gamma)=A\left(\frac{\Delta t_{i,j,}}{1 yr}\right)^{\gamma}.
\end {eqnarray}
The power-law model is fitted with given data where $\Delta m_{i,j,}$ is the difference in magnitude of light-curve points and $\Delta t_{i.j}$ is the separation between the magnitudes. The likliehood function is then:
\begin{eqnarray}
{\cal L}(A|\gamma)= \prod_{i,j} L_{i,j}, 
\end{eqnarray}
and the elements $L_{i,j}$ are
\begin{eqnarray}
L_{i,j}=\frac{1}{\sqrt{2\pi V_{eff,ij}^2}}exp\left(-\frac{\Delta m_{i,j}^2}{2V_{eff,ij}^2} \right).
\end{eqnarray}
The effective, observed variability is
\begin{eqnarray}
V_{eff,ij}^2=V_{mod}(\Delta t_{ij}|A,\gamma)^2+ (\sigma_i^2 + \sigma_j^2), 
\end{eqnarray} 
where $\sigma_i$ and $\sigma_j$ are the photometric errors. They utilize Stripe82 data to select extensive, complete and pure quasar samples.



\section{The model}

In our language, a ``model'' is a likelihood function---a function
equal to or proportional to a pdf in data space for the data given
parameters---and a set of prior pdfs for some or all of those
parameters.  For this project, the ``data'' for one quasar comprise a
set of $N$ observed magnitudes $m_n$.  About each data point we have
various bits of (assumed correct) meta data: We know the time $t_n$ at
which each measurement was made.  We know the astronomical bandpass
$b_n$ through which the measurement was made.  The bandpass variable
$b_n$ can only take on one of a small number of possible integer
values (5 in the case of \sdss\ and \panstarrs, each of which observe
in 5 substantially distinct bandpasses).  We also know the variance
$\sigma_n^2$ of the noise contribution to the measurement $m_n$, which
we will assume is not only correct but also represents the variance of
a Gaussian pdf for the noise.  That is, we are assuming Gaussian
uncertainties of known (though heteroskedastic) variance.

To generate the likelihood function we use here, we make
use of a Gaussian Process formulation for stochastic quasar
variability; this formulation can encompass damped random walks
and also power-law structure functions (and indeed many other kinds of
continuous stochastic variability).  The unusual aspect of the model
we use here is that the Gaussian Process is not in any particular band
but instead in an ersatz fiducial band which can be scaled and shifted
onto the particular bands.  This permits simultaneous treatment of
multiple bands, even when the multiple bands are not observed
simultaneously.  The key idea is that the ersatz band is a latent
variable---it is never directly observed; only the scaled and shifted
versions are observed, and even these are only observed in the
presence of substantial measurement noise.

In the damped random walk model, without loss of generality (the real
photometric measurements will be scaled and shifted to match the
latent ersatz basis), the ersatz lightcurve can be described with a
zero-mean and unit-characteristic-variance Gaussian Process.  That is,
the prior pdf for a set of $N$ ersatz ``magnitudes'' $q_n$ that are
instantiated at times $t_n$ is just
\begin{eqnarray}
p(q) &=& N(q\given 0,V)
\\
\transpose{q} &\equiv& [q_1, q_2, \cdots , q_N]
\\
V_{nn'} &=& \exp -\frac{|t_n - t_{n'}|}{\tau}
\quad ,
\end{eqnarray}
where $N(x\given\mu,V)$ is the multivariate normal for column vector
$x$ given mean vector $\mu$ and general variance tensor $V$, $q$ is
the $N$-dimensional column vector made up of all the latent ersatz
magnitudes $q_n$, $0$ is not zero but the $N$-dimensional
generalization of zero, $V$ is a $N\times N$ symmetric positive
definite matrix with elements $V_{nn'}$, and $\tau$ is the
decorrelation time of the random walk.  Some draws from this kind of
Gaussian Process are shown in \figurename~\ref{fig:qdraws}; it is a
model of stochastic variation with controlled correlation properties.

The pdf for an individual measurement $m_n$ given its meta data and a
value for the corresponding latent ersatz magnitude $q_n$ is found by
shifting and scaling the latent magnitude and adding Gaussian noise.
This makes a single-datum likelihood
\begin{eqnarray}
p(m_n\given q_n,b_n,\sigma_n^2) &=& N(m_n\given a(b_n) * q_n + \mu(b_n), \sigma_n^2)
\quad ,
\end{eqnarray}
where $a(b)$ is a scale appropriate to photometric bandpass $b$,
$\mu(b)$ is an offset or mean appropriate to bandpass $b$, and there
is one value of $a(b)$ and one value of $\mu(b)$ for each possible
value of the bandpass $b$.  Because everything is Gaussian, the latent
ersatz magnitudes never have to be explicitly inferred individually;
they can all be marginalized out analytically.

This marginalization (to remove all explicit mention of the ersatz
variable $q$) leads to the following very simple covariance function
for the data:
\begin{eqnarray}
p(m) &=& N(m\given \mu,V)
\label{eq:likestart}
\\
\transpose{m} &\equiv& [m_1, m_2, \cdots , m_N]
\\
\transpose{\mu} &=& [\mu(b_1), \mu(b_2), \cdots , \mu(b_N)]
\\
V_{nn'} &=& a(b_n)\,a(b_{n'})\,\exp -\frac{|t_n - t_{n'}|}{\tau} + \sigma_n^2\,\delta_{nn'}
\label{eq:likeend}
\quad ,
\end{eqnarray}
where $m$ is a column vector of all the observations (from all bands),
$\mu$ is a column vector of all the means, with each mean value in the
vector drawn from the list of five means $\mu(b)$ but appropriately
for the data point in question, the rows and columns of the variance
tensor $V$ have been multiplied by the scales $a(b)$ appropriate for
the relevant observations, and there is an additional term
$\sigma_n^2$ added only to the diagonal elements to model the
measurement noise variance.  This model is very rigid, in that the
bandpasses are tightly tied to one another, but also very flexible, in
that the quasar can have any mean color and that color can change
(deterministically) as it brightens (as is observed [HOGG CITE]).
Some draws from this multi-band damped-random-walk Gaussian Process
are shown in \figurename~\ref{fig:mdraws}

The equations~(\ref{eq:likestart}) through (\ref{eq:likeend})
provide a method for computing the probability of any data set (any
set of observed magnitudes $m_n$) given meta data (times $t_n$,
bandpasses $b_n$, observational uncertainties $\sigma_n^2$) and
parameters $a(b)$ (five numbers), $\mu(b)$ (five numbers), and $\tau$.
The probability of the observed data given parameters is the
\emph{likelihood function}.  Thus we can bring the whole machinery of
probabilistic inference (likelihood optimization, posterior sampling)
to the problem.  Also, because both the process is Gaussian and the
noise is (assumed to be) Gaussian, it is trivial to make prior draws
of expected data, and also make \emph{conditional predictions} for new
data $\tilde{m}_k$ at $K$ times $t_k$ taken through bandpasses $b_k$ with
expected uncertainties $\sigma_k^2$ given the data in hand (which are
at $N$ times $t_n$):
\begin{eqnarray}
p(\tilde{m}|m) &=& N(\tilde{m}|\tilde{\mu},\tilde{V})
\\
\transpose{\tilde{m}} &\equiv& [\tilde{m}_1, \tilde{m}_2, \cdots , \tilde{m}_K]
\\
\tilde{\mu} &=& \nu + X\cdot\inverse{V}\cdot [m - \mu]
\\
\tilde{V} &=& Y - X\cdot\inverse{V}\cdot\transpose{X}
\\
\transpose{\nu} &=& [\mu(b_1), \mu(b_2), \cdots , \mu(b_K)]
\\
X_{kn} &=& a(b_k)\,a(b_n)\,\exp -\frac{|t_k - t_n|}{\tau}
\\
Y_{kk'} &=& a(b_k)\,a(b_{k'})\,\exp -\frac{|t_k - t_{k'}|}{\tau} + \sigma_k^2\,\delta_{kk'}
\quad ,
\end{eqnarray}
where $\tilde{m}$ is the column vector of conditional predictions,
$\tilde{\mu}$ and $\tilde{V}$ are a conditional mean vector and a
conditional variance tensor, (temporary) mean vector $\nu$ is
$K$-dimensional, and the matrices $V$, $X$, and $Y$ are $N\times N$,
$K\times N$, and $K\times K$ respectively.  Vectors $m$ and $\mu$ and
matrix $V$ are defined above in equations~(\ref{eq:likestart}) through
(\ref{eq:likeend}).  These conditional predictions depend on the
Gaussian Process parameters.  They represent an adjusted Gaussian
Process, adjusted to ``go through'' (or at least near) the existing
data.  We show an example of conditional predictions in
\figurename~\ref{fig:conditional}

\section{Experiments}

\section{Discussion}

...Promise for \lsst...

...Caveats related to reverberation mapping...

%\acknowledgements
It is a pleasure to thank Zoubin Ghahramani (Cambridge) for posting a
very valuable Gaussian Process tutorial online.

\clearpage
\begin{figure}
~[DM + EP]~
\caption{Four draws from the damped random walk model for the latent
  variable $q$.  These draws are made with $a=0.75$~mag and
  $\tau=400$~d.\label{fig:qdraws}}
\end{figure}

\begin{figure}
~[DM + EP]~
\caption{Four draws from the multi-band damped random walk model in
  the five SDSS bands.  These draws are made with $a(b)=(0.85, 0.75,
  0.65, 0.55, 0.45)$~mag in the five bandpasses, $\mu(b)=$[DM+EP], and
  $\tau=400$~d.  The model is rigid in the sense that the five bands
  are all scaled replicas of one another.\label{fig:mdraws}}
\end{figure}

\begin{figure}
~[DM + EP]~
\caption{Example of conditional
  prediction... [DM+EP]\label{fig:conditional}}
\end{figure}

\end{document}
